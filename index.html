<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bridge - Connect. Collaborate. Close.</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        :root {
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F5F5F5;
            --bg-dark: #000000;
            --text-primary: #000000;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --accent-gold: #C9A961;
            --accent-sage: #E8F3E8;
            --accent-coral: #FFE8E8;
            --border-light: #EEEEEE;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            z-index: 1000;
            border-bottom: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            height: 56px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            width: 36px;
            height: 36px;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-gold);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            z-index: 1000;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.04);
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0 1.5rem;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            text-decoration: none;
            color: var(--text-tertiary);
            cursor: pointer;
            position: relative;
        }

        .nav-item.active {
            color: var(--text-primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 2px;
            background: var(--bg-dark);
            border-radius: 2px;
        }

        /* Main Content */
        .main-content {
            padding-top: 56px;
            padding-bottom: 80px;
            min-height: 100vh;
        }

        .page {
            display: none;
        }

        /* Search */
        .search-wrapper {
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            font-size: 0.9375rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--border-light);
        }

        /* Filter Pills */
        .filter-section {
            padding: 1rem;
            background: var(--bg-secondary);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .filter-pills {
            display: flex;
            gap: 0.5rem;
            min-width: max-content;
        }

        .filter-pill {
            padding: 0.5rem 1.25rem;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-pill.active {
            background: var(--bg-dark);
            color: white;
        }

        /* Property Cards */
        .properties-container {
            padding: 1rem;
        }

        .property-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .property-card:active {
            transform: scale(0.98);
        }

        .property-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .property-content {
            padding: 1.25rem;
        }

        .property-price {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .property-location {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            margin-bottom: 0.75rem;
        }

        .property-specs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .commission-badge {
            background: var(--accent-gold);
            color: var(--bg-dark);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
        }

        /* Forms */
        .form-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .form-field {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.875rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.9375rem;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn-primary {
            background: var(--bg-dark);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-gold {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            margin: 3rem auto 2rem;
            max-width: 480px;
            animation: slideUp 0.3s ease;
            padding: 1.5rem;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--bg-dark);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success Message */
        .success-message {
            background: var(--accent-sage);
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        /* Login */
        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Developer Section */
        .developer-hero {
            background: var(--bg-dark);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
        }

        .developer-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .developer-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Media Grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .media-item {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .media-item:active {
            transform: scale(0.95);
        }

        .media-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .media-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            color: white;
            padding: 1rem 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            z-index: 3000;
            display: none;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        @media (min-width: 768px) {
            .main-content {
                max-width: 768px;
                margin: 0 auto;
            }
            
            .properties-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .property-card {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-container">
                <div class="logo">
                    <svg viewBox="0 0 36 36" fill="none">
                        <rect x="4" y="8" width="6" height="20" rx="1" fill="#000000"/>
                        <rect x="26" y="8" width="6" height="20" rx="1" fill="#000000"/>
                        <path d="M4 18 Q18 12 32 18" stroke="#C9A961" stroke-width="3" fill="none"/>
                        <path d="M7 8 L18 18 L29 8" stroke="#000000" stroke-width="1.5" fill="none"/>
                    </svg>
                </div>
                <span class="logo-text">Bridge</span>
            </div>
            <div id="userInfo" class="user-info" style="display: none;">
                <div id="userAvatar" class="user-avatar"></div>
                <span id="userName" style="font-size: 0.875rem;"></span>
            </div>
        </div>
    </header>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-container">
            <div class="nav-item active" onclick="showPage('home')">
                <span>üè†</span>
                <span style="font-size: 0.75rem;">Home</span>
            </div>
            <div class="nav-item" onclick="showPage('developers')">
                <span>üè¢</span>
                <span style="font-size: 0.75rem;">Developers</span>
            </div>
            <div class="nav-item" onclick="showPage('add')">
                <span>‚ûï</span>
                <span style="font-size: 0.75rem;">List</span>
            </div>
            <div class="nav-item" onclick="showPage('saved')">
                <span>üíæ</span>
                <span style="font-size: 0.75rem;">Saved</span>
            </div>
            <div class="nav-item" onclick="showPage('profile')">
                <span>üë§</span>
                <span style="font-size: 0.75rem;">Profile</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Login Page -->
        <div id="loginPage" class="page">
            <div class="login-container">
                <div class="login-header">
                    <h1 class="login-title">Welcome to Bridge</h1>
                    <p style="color: var(--text-secondary);">Connect. Collaborate. Close.</p>
                </div>
                
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-section">
                        <div class="form-field">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="loginEmail" required>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Access Code</label>
                            <input type="password" class="form-input" id="loginPassword" placeholder="Enter your access code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Sign In</button>
                    </div>
                </form>
                
                <p style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                    Demo: demo@bridge.co.ke / demo123
                </p>
            </div>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page" style="display: none;">
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Search by area..." onkeyup="searchProperties(event)">
            </div>
            
            <div class="filter-section">
                <div class="filter-pills" id="areaFilters">
                    <div class="filter-pill active" onclick="filterByArea('All')">All Areas</div>
                </div>
            </div>
            
            <div class="properties-container">
                <div id="propertyList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading properties...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Developers Page -->
        <div id="developersPage" class="page" style="display: none;">
            <div class="developer-hero">
                <h1 style="font-size: 1.875rem; margin-bottom: 0.5rem;">Developer Projects</h1>
                <p>Direct from developers ‚Ä¢ Full documentation</p>
                <div class="developer-stats">
                    <div class="developer-stat">
                        <div class="stat-value" id="totalProjects">0</div>
                        <div class="stat-label">Active Projects</div>
                    </div>
                    <div class="developer-stat">
                        <div class="stat-value">3-5%</div>
                        <div class="stat-label">Commission</div>
                    </div>
                    <div class="developer-stat">
                        <div class="stat-value" id="totalUnits">0</div>
                        <div class="stat-label">Units Available</div>
                    </div>
                </div>
            </div>
            
            <div class="properties-container">
                <div id="developerList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading projects...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Listing Page -->
        <div id="addPage" class="page" style="display: none;">
            <div style="padding: 1.5rem; max-width: 600px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 2rem;">List Your Property</h2>
                
                <div id="listingSuccess" class="success-message" style="display: none;">
                    ‚úì Property submitted successfully! We'll review and activate it soon.
                </div>
                
                <form id="addListingForm" onsubmit="submitListing(event)">
                    <div class="form-section">
                        <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 1rem;">Property Details</h3>
                        
                        <div class="form-field">
                            <label class="form-label">Property Type</label>
                            <select class="form-select" name="PropertyType" required>
                                <option value="">Select type</option>
                                <option value="Apartment">Apartment</option>
                                <option value="House">House</option>
                                <option value="Townhouse">Townhouse</option>
                                <option value="Land">Land</option>
                                <option value="Commercial">Commercial</option>
                            </select>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">General Area (Public)</label>
                            <input type="text" class="form-input" name="Area" placeholder="e.g., Westlands" required>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Exact Address (Private)</label>
                            <input type="text" class="form-input" name="FullAddress" placeholder="Full address with street" required>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Price (KES)</label>
                            <input type="number" class="form-input" name="Price" required>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Bedrooms</label>
                            <input type="number" class="form-input" name="Bedrooms" min="0" required>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Bathrooms</label>
                            <input type="number" class="form-input" name="Bathrooms" min="0" step="0.5" required>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Size</label>
                            <input type="text" class="form-input" name="Size" placeholder="e.g., 145 sqm">
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Total Commission (%)</label>
                            <select class="form-select" name="TotalCommission" required>
                                <option value="3">3%</option>
                                <option value="3.5">3.5%</option>
                                <option value="4">4%</option>
                                <option value="5">5%</option>
                            </select>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Commission Split</label>
                            <select class="form-select" name="CommissionSplit" required>
                                <option value="50-50">50/50 - Equal split</option>
                                <option value="60-40">60/40 - Listing agent favor</option>
                                <option value="40-60">40/60 - Selling agent favor</option>
                            </select>
                        </div>
                        
                        <div class="form-field">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" name="Description" rows="4" placeholder="Property description..."></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Submit Property</button>
                </form>
            </div>
        </div>

        <!-- Saved Page -->
        <div id="savedPage" class="page" style="display: none;">
            <div style="padding: 1rem;">
                <h2 style="font-size: 1.125rem; margin-bottom: 1rem;">Saved Properties</h2>
                <div id="savedList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No saved properties yet</p>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="page" style="display: none;">
            <div style="padding: 1.5rem; text-align: center;">
                <h2 style="margin-bottom: 1rem;">Your Profile</h2>
                <div id="profileInfo" style="margin-bottom: 2rem;"></div>
                <button class="btn btn-primary" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </main>

    <!-- Property Modal -->
    <div id="propertyModal" class="modal" onclick="closeModalOnOutside(event)">
        <div class="modal-content" id="modalContent">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Configuration
        const AIRTABLE_API_KEY = 'patnr2ahdHJSQvYM0.1f71a8a57d95d0ec22b0d6f5a38ce8b9a26b2c375c38b86ed696bd35444b877c';
        const AIRTABLE_BASE_ID = 'appMw7aGUXAcajzdS';
        
        // Table names from your Airtable
        const TABLES = {
            AGENTS: 'Agents',
            PROPERTIES: 'Properties',
            DEVELOPER_PROJECTS: 'DeveloperProjects',
            PROJECT_MEDIA: 'ProjectMedia',
            CONNECTIONS: 'Connections',
            PROPERTY_VIEWS: 'PropertyViews'
        };
        
        // Simple authentication
        const VALID_AGENTS = {
            'demo@bridge.co.ke': 'demo123',
            'agent1@bridge.co.ke': 'bridge2024',
            'agent2@bridge.co.ke': 'bridge2024',
            'sarah@bridge.co.ke': 'sarah123',
            'james@bridge.co.ke': 'james123'
        };

        // Kenyan areas
        const KENYA_AREAS = [
            'Westlands', 'Kilimani', 'Karen', 'Kileleshwa', 'Lavington',
            'Runda', 'Muthaiga', 'Parklands', 'South B', 'South C',
            'Langata', 'Ridgeways', 'Gigiri', 'Spring Valley', 'Loresho'
        ];

        // State
        let currentUser = null;
        let properties = [];
        let developerProjects = [];
        let currentFilter = 'All';
        let savedProperties = JSON.parse(localStorage.getItem('bridgeSaved') || '[]');

        // Initialize
        function init() {
            const user = localStorage.getItem('bridgeUser');
            if (user) {
                currentUser = JSON.parse(user);
                showUserInfo();
                showPage('home');
                loadData();
            } else {
                showPage('login');
            }
            
            // Populate area filters
            const filterContainer = document.getElementById('areaFilters');
            KENYA_AREAS.forEach(area => {
                const pill = document.createElement('div');
                pill.className = 'filter-pill';
                pill.textContent = area;
                pill.onclick = () => filterByArea(area);
                filterContainer.appendChild(pill);
            });
        }

        // Show user info
        function showUserInfo() {
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (VALID_AGENTS[email] === password) {
                currentUser = { 
                    email, 
                    name: email.split('@')[0].charAt(0).toUpperCase() + email.split('@')[0].slice(1)
                };
                localStorage.setItem('bridgeUser', JSON.stringify(currentUser));
                showUserInfo();
                showPage('home');
                loadData();
                showToast('Welcome to Bridge!');
            } else {
                showToast('Invalid credentials. Please try again.');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('bridgeUser');
            currentUser = null;
            window.location.reload();
        }

        // Load all data
        async function loadData() {
            await Promise.all([
                loadProperties(),
                loadDeveloperProjects()
            ]);
        }

        // Load properties from Airtable
        async function loadProperties() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${TABLES.PROPERTIES}?filterByFormula={Status}='Active'&sort[0][field]=CreatedDate&sort[0][direction]=desc`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                properties = data.records.map(record => ({
                    id: record.id,
                    ...record.fields
                }));

                renderProperties();
            } catch (error) {
                console.error('Error loading properties:', error);
                document.getElementById('propertyList').innerHTML = 
                    '<p style="text-align: center; color: var(--text-secondary);">Failed to load properties. Please refresh.</p>';
            }
        }

        // Load developer projects
        async function loadDeveloperProjects() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${TABLES.DEVELOPER_PROJECTS}?filterByFormula={Status}='Active'`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                developerProjects = data.records.map(record => ({
                    id: record.id,
                    ...record.fields
                }));

                // Update stats
                document.getElementById('totalProjects').textContent = developerProjects.length;
                const totalUnits = developerProjects.reduce((sum, p) => sum + (p.UnitsAvailable || 0), 0);
                document.getElementById('totalUnits').textContent = totalUnits;

                renderDeveloperProjects();
            } catch (error) {
                console.error('Error loading developer projects:', error);
            }
        }

        // Render properties
        function renderProperties(propertiesToRender = properties) {
            const container = document.getElementById('propertyList');
            
            if (propertiesToRender.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No properties found</p>';
                return;
            }

            container.innerHTML = propertiesToRender.map(property => {
                const imageUrl = property.Images && property.Images[0] 
                    ? property.Images[0].url 
                    : 'https://via.placeholder.com/400x200?text=No+Image';

                return `
                    <div class="property-card" onclick="showPropertyDetails('${property.id}')">
                        <img src="${imageUrl}" alt="Property" class="property-image">
                        <div class="property-content">
                            <div class="property-price">KES ${formatPrice(property.Price || 0)}</div>
                            <div class="property-location">üìç ${property.Area || 'Area not specified'}</div>
                            <div class="property-specs">
                                <span>üõè ${property.Bedrooms || 0} beds</span>
                                <span>üöø ${property.Bathrooms || 0} baths</span>
                                <span>üìê ${property.Size || 'N/A'}</span>
                            </div>
                            <div class="commission-badge">
                                ${property.TotalCommission || 3}% ‚Ä¢ ${property.CommissionSplit || '50-50'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render developer projects
        function renderDeveloperProjects() {
            const container = document.getElementById('developerList');
            
            if (developerProjects.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No projects available</p>';
                return;
            }

            container.innerHTML = developerProjects.map(project => {
                const imageUrl = project.MainImage && project.MainImage[0] 
                    ? project.MainImage[0].url 
                    : 'https://via.placeholder.com/400x200?text=No+Image';

                return `
                    <div class="property-card" onclick="showDeveloperDetails('${project.id}')">
                        <img src="${imageUrl}" alt="${project.ProjectName}" class="property-image">
                        <div class="property-content">
                            <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">${project.ProjectName || 'Unnamed Project'}</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">by ${project.Developer || 'Developer'}</p>
                            <div class="property-price">From KES ${formatPrice(project.PriceFrom || 0)}</div>
                            <div class="property-location">üìç ${project.Area || 'Location'}</div>
                            <div style="margin-top: 1rem;">
                                <span class="commission-badge">${project.Commission || 5}% Commission</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show property details
        function showPropertyDetails(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return;

            const isSaved = savedProperties.includes(propertyId);

            // Log property view
            logPropertyView(propertyId);

            document.getElementById('modalContent').innerHTML = `
                <div class="modal-header">
                    <h3>Property in ${property.Area}</h3>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                
                <div style="background: var(--accent-sage); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                    <p style="font-size: 0.875rem;">Listed by: ${property.AgentName || 'Agent'} ‚Ä¢ ${property.Agency || 'Agency'}</p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <p><strong>Type:</strong> ${property.PropertyType || 'Not specified'}</p>
                    <p><strong>Configuration:</strong> ${property.Bedrooms || 0} Bed, ${property.Bathrooms || 0} Bath</p>
                    <p><strong>Size:</strong> ${property.Size || 'Not specified'}</p>
                    <p><strong>Price:</strong> KES ${formatPrice(property.Price || 0)}</p>
                    ${property.Description ? `<p style="margin-top: 1rem;">${property.Description}</p>` : ''}
                </div>
                
                <div style="background: var(--bg-dark); color: white; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;">Commission Structure</h4>
                    <p>Total: ${property.TotalCommission || 3}% ‚Ä¢ Split: ${property.CommissionSplit || '50-50'}</p>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                        Your potential earnings: KES ${formatPrice(calculateCommission(property.Price, property.TotalCommission, property.CommissionSplit))}
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="requestContact('${propertyId}')">
                        Request Contact
                    </button>
                    <button class="btn btn-gold" style="flex: 1;" onclick="toggleSave('${propertyId}')">
                        ${isSaved ? 'Unsave' : 'Save'}
                    </button>
                </div>
            `;

            document.getElementById('propertyModal').style.display = 'block';
        }

        // Show developer details
        function showDeveloperDetails(projectId) {
            const project = developerProjects.find(p => p.id === projectId);
            if (!project) return;

            // Load media files for this project
            loadProjectMedia(projectId).then(mediaFiles => {
                const mediaHtml = mediaFiles.length > 0 ? `
                    <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Downloadable Documents</h4>
                    <div class="media-grid">
                        ${mediaFiles.map(media => `
                            <a href="${media.FileUrl}" target="_blank" class="media-item">
                                <div class="media-icon">${getMediaIcon(media.Type)}</div>
                                <div class="media-name">${media.Name}</div>
                            </a>
                        `).join('')}
                    </div>
                ` : '';

                document.getElementById('modalContent').innerHTML = `
                    <div class="modal-header">
                        <h3>${project.ProjectName}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">by ${project.Developer}</p>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p><strong>Location:</strong> ${project.Area}</p>
                        <p><strong>Price Range:</strong> KES ${formatPrice(project.PriceFrom || 0)} - ${formatPrice(project.PriceTo || 0)}</p>
                        <p><strong>Units Available:</strong> ${project.UnitsAvailable || 0} of ${project.TotalUnits || 0}</p>
                        <p><strong>Completion:</strong> ${project.CompletionDate || 'TBD'}</p>
                        <p><strong>Commission:</strong> ${project.Commission || 5}%</p>
                        ${project.PropertyTypes ? `<p><strong>Types:</strong> ${project.PropertyTypes}</p>` : ''}
                        ${project.Amenities ? `<p><strong>Amenities:</strong> ${project.Amenities}</p>` : ''}
                    </div>
                    
                    ${mediaHtml}
                    
                    <div style="background: var(--bg-dark); color: white; padding: 1rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                        <h4 style="margin-bottom: 0.5rem;">Contact Developer</h4>
                        <p style="font-size: 0.875rem;">${project.ContactName || 'Contact Person'}</p>
                        <p style="font-size: 0.875rem;">üìû ${project.ContactPhone || 'Not provided'}</p>
                        <p style="font-size: 0.875rem;">‚úâÔ∏è ${project.ContactEmail || 'Not provided'}</p>
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeModal()">Close</button>
                `;
            });

            document.getElementById('propertyModal').style.display = 'block';
        }

        // Load project media
        async function loadProjectMedia(projectId) {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${TABLES.PROJECT_MEDIA}?filterByFormula={ProjectId}='${projectId}'`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        }
                    }
                );

                if (!response.ok) return [];

                const data = await response.json();
                return data.records.map(record => record.fields);
            } catch (error) {
                console.error('Error loading media:', error);
                return [];
            }
        }

        // Get media icon
        function getMediaIcon(type) {
            const icons = {
                'PDF': 'üìÑ',
                'Image': 'üñºÔ∏è',
                'Video': 'üé•',
                'Document': 'üìã'
            };
            return icons[type] || 'üìé';
        }

        // Submit listing
        async function submitListing(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const listing = {
                PropertyType: formData.get('PropertyType'),
                Area: formData.get('Area'),
                FullAddress: formData.get('FullAddress'),
                Price: parseInt(formData.get('Price')),
                Bedrooms: parseInt(formData.get('Bedrooms')),
                Bathrooms: parseFloat(formData.get('Bathrooms')),
                Size: formData.get('Size'),
                TotalCommission: parseFloat(formData.get('TotalCommission')),
                CommissionSplit: formData.get('CommissionSplit'),
                Description: formData.get('Description'),
                AgentName: currentUser.name,
                AgentEmail: currentUser.email,
                Agency: 'Independent', // You can make this a form field
                Status: 'Pending',
                CreatedDate: new Date().toISOString()
            };

            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${TABLES.PROPERTIES}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields: listing })
                    }
                );

                if (response.ok) {
                    document.getElementById('listingSuccess').style.display = 'block';
                    event.target.reset();
                    showToast('Property submitted successfully!');
                    setTimeout(() => {
                        document.getElementById('listingSuccess').style.display = 'none';
                        showPage('home');
                    }, 3000);
                } else {
                    const error = await response.json();
                    console.error('Airtable error:', error);
                    showToast('Failed to submit listing. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting listing:', error);
                showToast('Error submitting listing. Please check your connection.');
            }
        }

        // Request contact
        async function requestContact(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return;

            try {
                // Create connection request
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${TABLES.CONNECTIONS}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                PropertyId: propertyId,
                                ListingAgentId: property.AgentId || property.AgentEmail,
                                RequestingAgentId: currentUser.email,
                                RequestingAgentName: currentUser.name,
                                Status: 'Pending',
                                RequestedDate: new Date().toISOString()
                            }
                        })
                    }
                );

                if (response.ok) {
                    showToast('Contact request sent! The agent will respond soon.');
                    closeModal();
                } else {
                    showToast('Failed to send request. Please try again.');
                }
            } catch (error) {
                console.error('Error sending request:', error);
                showToast('Error sending request.');
            }
        }

        // Log property view
        async function logPropertyView(propertyId) {
            try {
                await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${TABLES.PROPERTY_VIEWS}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                PropertyId: propertyId,
                                AgentId: currentUser.email,
                                ViewedAt: new Date().toISOString()
                            }
                        })
                    }
                );
            } catch (error) {
                console.error('Error logging view:', error);
            }
        }

        // Toggle save property
        function toggleSave(propertyId) {
            const index = savedProperties.indexOf(propertyId);
            if (index > -1) {
                savedProperties.splice(index, 1);
                showToast('Property removed from saved');
            } else {
                savedProperties.push(propertyId);
                showToast('Property saved');
            }
            localStorage.setItem('bridgeSaved', JSON.stringify(savedProperties));
            showPropertyDetails(propertyId);
        }

        // Search properties
        function searchProperties(event) {
            const searchTerm = event.target.value.toLowerCase();
            const filtered = properties.filter(p => 
                (p.Area && p.Area.toLowerCase().includes(searchTerm)) ||
                (p.PropertyType && p.PropertyType.toLowerCase().includes(searchTerm))
            );
            renderProperties(filtered);
        }

        // Filter by area
        function filterByArea(area) {
            currentFilter = area;
            
            // Update active state
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.textContent === area) {
                    pill.classList.add('active');
                }
            });

            // Filter properties
            if (area === 'All') {
                renderProperties(properties);
            } else {
                const filtered = properties.filter(p => p.Area === area);
                renderProperties(filtered);
            }
        }

        // Calculate commission
        function calculateCommission(price, totalCommission, split) {
            const total = price * (totalCommission || 3) / 100;
            const [listing, selling] = (split || '50-50').split('-').map(Number);
            return total * selling / 100;
        }

        // Show saved properties
        function renderSavedProperties() {
            const saved = properties.filter(p => savedProperties.includes(p.id));
            const container = document.getElementById('savedList');
            
            if (saved.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No saved properties yet</p>';
                return;
            }

            container.innerHTML = saved.map(property => {
                const imageUrl = property.Images && property.Images[0] 
                    ? property.Images[0].url 
                    : 'https://via.placeholder.com/400x200?text=No+Image';

                return `
                    <div class="property-card" onclick="showPropertyDetails('${property.id}')">
                        <img src="${imageUrl}" alt="Property" class="property-image">
                        <div class="property-content">
                            <div class="property-price">KES ${formatPrice(property.Price || 0)}</div>
                            <div class="property-location">üìç ${property.Area}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show profile
        function showProfile() {
            document.getElementById('profileInfo').innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: var(--accent-gold); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600;">
                        ${currentUser.name.charAt(0).toUpperCase()}
                    </div>
                    <p style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">${currentUser.name}</p>
                    <p style="color: var(--text-secondary);">${currentUser.email}</p>
                </div>
            `;
        }

        // Navigation
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            switch(page) {
                case 'login':
                    document.getElementById('loginPage').style.display = 'block';
                    break;
                case 'home':
                    document.getElementById('homePage').style.display = 'block';
                    break;
                case 'developers':
                    document.getElementById('developersPage').style.display = 'block';
                    break;
                case 'add':
                    document.getElementById('addPage').style.display = 'block';
                    break;
                case 'saved':
                    document.getElementById('savedPage').style.display = 'block';
                    renderSavedProperties();
                    break;
                case 'profile':
                    document.getElementById('profilePage').style.display = 'block';
                    showProfile();
                    break;
            }

            if (page !== 'login') {
                event.target.closest('.nav-item')?.classList.add('active');
            }
        }

        // Utilities
        function formatPrice(price) {
            if (price >= 1000000) {
                return (price / 1000000).toFixed(1) + 'M';
            }
            return (price / 1000).toFixed(0) + 'K';
        }

        function closeModal() {
            document.getElementById('propertyModal').style.display = 'none';
        }

        function closeModalOnOutside(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
